<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - WE SEND MONEY</title>
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="logo.svg" alt="Logo" width="70" height="70">
              <h1 style="margin-left: -20px; font-size: 15px; transform: translateY(4px);">
        <span style="color: white;">E</span><span style="color: white;">SEND</span><span style="color: white;">MONEY</span></h1>
        </div>
    </header>

    <div class="container">
        <h1>Inicio de Sesión</h1>
        <div class="input-group">
            <label for="loginEmail">Correo electrónico</label>
            <input type="email" id="loginEmail" placeholder="Correo electrónico" required>
        </div>
        <div class="input-group">
            <label for="loginPassword">Contraseña</label>
            <input type="password" id="loginPassword" placeholder="Contraseña" required>
        </div>
        <div class="input-group">
            <div id="message"></div>
            <button class="login-button" onclick="login()">Iniciar Sesión</button>
        </div>
        <hr>
        <span class="register-link" onclick="window.location.href='register.html'">¿No tienes cuenta? Regístrate</span>
    </div>

    <script src="scripts.js"></script>
    <!-- Agrega esto antes del cierre de </body> -->
<script>
document.getElementById("loginForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    
function login() {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;

    if (!email || !password) {
        showMessage("Por favor, completa todos los campos.");
        return;
    }

    showLoader();

    fetch(`${apiUrl}?action=login&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`)
        .then((response) => {
            if (!response.ok) {
                throw new Error("Error en la respuesta de la API");
            }
            return response.json();
        })
        .then((data) => {
            if (data.success) {
                await initializePushNotifications();
                // Guardar todos los datos relevantes en localStorage
                localStorage.setItem("currentUser", JSON.stringify(data.user));
                localStorage.setItem("userRole", data.role);
                localStorage.setItem("userCurrency", data.user.country);
                localStorage.setItem("userEmail", data.user.email); // Guardar email para futuras verificaciones
                localStorage.setItem("isLoggedIn", "true"); // Bandera de sesión activa
                localStorage.setItem("lastActivity", Date.now()); // Registrar última actividad

                currentUser = data.user.name;
                userCurrency = data.user.country;
                showMessage("Inicio de sesión exitoso!", false);
                
                window.location.href = "calculator.html";
            } else {
                showMessage("Credenciales inválidas: " + data.message);
            }
        })
        .catch((error) => {
            console.error("Error:", error);
            showMessage("Ocurrió un error durante el inicio de sesión.");
        })
        .finally(() => {
            hideLoader();
        });
}
    
async function initializePushNotifications() {
    if ('serviceWorker' in navigator && 'PushManager' in window) {
        try {
            const token = await requestNotificationPermission();
            if (token) {
                await saveFCMToken(token);
                
                // Configurar el listener de mensajes
                messaging.onMessage((payload) => {
                    console.log('Mensaje recibido:', payload);
                    if (payload.notification) {
                        showCustomNotification(payload.notification.title, payload.notification.body);
                    }
                });
            }
        } catch (error) {
            console.error('Error inicializando notificaciones:', error);
        }
    }
}
</script>
</body>
</html>
